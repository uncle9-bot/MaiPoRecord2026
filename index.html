<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>米埔支出管理 2026</title>
    <style>
        :root {
            --primary-bg: #fcf8e3;
            --header-bg: #f7e1a0;
            --summary-blue: #00ffff;
            --summary-grey: #d9d9d9;
        }
        body { font-family: -apple-system, system-ui; background: var(--primary-bg); margin: 0; padding: 15px; padding-bottom: 50px; }
        h2 { font-size: 1.2rem; border-left: 5px solid #f0ad4e; padding-left: 10px; margin-bottom: 15px; }

        .form-section { background: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .grid-input { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .full-width { grid-column: span 2; }
        label { font-size: 12px; color: #666; display: block; margin-bottom: 3px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; box-sizing: border-box; background: white; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 5px; font-weight: bold; font-size: 16px; }
        .btn-add { background: #5cb85c; color: white; }
        .btn-update { background: #4a90e2; color: white; display: none; }

        /* 淨額顯示區 */
        .net-display { background: #fff; padding: 10px; border-radius: 5px; border: 2px solid #f0ad4e; margin-bottom: 10px; text-align: center; font-weight: bold; font-size: 1.1rem; }

        .table-wrapper { overflow-x: auto; background: #fff; border: 1px solid #ddd; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; font-size: 14px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: left; }
        th { background: var(--header-bg); position: sticky; top: 0; }
        
        .summary-container { margin-top: 20px; display: grid; grid-template-columns: 1fr; gap: 10px; }
        .summary-card { padding: 12px; border-radius: 8px; font-size: 14px; line-height: 1.6; }
        .blue-card { background: var(--summary-blue); border: 1px solid #00cccc; }
        .grey-card { background: var(--summary-grey); border: 1px solid #bbb; }
        .btn-del { background: #ff4d4d; color: white; border: none; padding: 5px 8px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>

    <h2>米埔支出管理 2026</h2>

    <div class="form-section">
        <div class="grid-input">
            <div class="full-width">
                <label>詳情</label>
                <input type="text" id="details" placeholder="輸入詳情內容">
            </div>
            <div>
                <label>日期</label>
                <input type="date" id="date">
            </div>
            <div>
                <label>類別</label>
                <select id="category">
                    <option value="Medical">Medical</option>
                    <option value="Medicine">Medicine</option>
                    <option value="Contribution">Contribution</option>
                    <option value="Domestic Helper">Domestic Helper</option>
                    <option value="Home">Home</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div>
                <label>金額 ($)</label>
                <input type="number" id="expense" placeholder="0">
            </div>
            <div>
                <label>預付/存入者</label>
                <select id="person">
                    <option value="">請選擇人員</option>
                    <option value="Josephine">Josephine</option>
                    <option value="Thomas">Thomas</option>
                    <option value="Kelvin">Kelvin</option>
                    <option value="Sylvia">Sylvia</option>
                    <option value="Kathy">Kathy</option>
                    <option value="Charles">Charles</option>
                    <option value="Matthew">Matthew</option>
                    <option value="Edward">Edward</option>
                </select>
            </div>
        </div>
        <div class="btn-group">
            <button id="addBtn" class="btn-add" onclick="addRecord()">新增記錄</button>
            <button id="updateBtn" class="btn-update" onclick="updateRecord()">完成修改</button>
        </div>
    </div>

    <div class="net-display" id="netAmountDisplay">
        結餘淨額: $0
    </div>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>選取</th>
                    <th>日期</th>
                    <th>詳情</th>
                    <th>類別</th>
                    <th>金額</th>
                    <th>人員</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="dataList"></tbody>
        </table>
    </div>

    <div class="summary-container">
        <div class="summary-card blue-card">
            <strong>各人 Contribution 總額：</strong>
            <div id="contributionSummary">尚無資料</div>
        </div>
        <div class="summary-card grey-card">
            <strong>選取項目合計：</strong>
            <div id="selectedTotal" style="font-size: 1.2rem; font-weight: bold;">$0</div>
        </div>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('maipo_db')) || [];
        let editId = null;

        document.getElementById('date').valueAsDate = new Date();

        function render() {
            const list = document.getElementById('dataList');
            list.innerHTML = '';
            let selectedSum = 0;
            let netTotal = 0;
            let contriMap = { "Josephine":0, "Thomas":0, "Kelvin":0, "Sylvia":0, "Kathy":0, "Charles":0, "Matthew":0, "Edward":0 };

            // 排序：日期從新到舊
            db.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach((item) => {
                // 淨額計算：如果是 Contribution 視為存入(+)，其他視為支出(-)
                if (item.category === "Contribution") {
                    netTotal += item.expense;
                    if (contriMap.hasOwnProperty(item.person)) {
                        contriMap[item.person] += item.expense;
                    }
                } else {
                    netTotal -= item.expense;
                }
                
                if (item.checked) selectedSum += item.expense;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" ${item.checked ? 'checked' : ''} onchange="toggleCheck('${item.id}')"></td>
                    <td>${item.date.substring(5)}</td>
                    <td>${item.details}</td>
                    <td>${item.category}</td>
                    <td style="color:${item.category==='Contribution'?'green':'red'}; font-weight:bold">$${item.expense}</td>
                    <td>${item.person}</td>
                    <td>
                        <button onclick="editRecord('${item.id}')">改</button>
                        <button class="btn-del" onclick="deleteRecord('${item.id}')">刪</button>
                    </td>
                `;
                list.appendChild(tr);
            });

            // 更新顯示
            document.getElementById('netAmountDisplay').innerText = `目前結餘淨額 (Net): $${netTotal.toLocaleString()}`;
            document.getElementById('selectedTotal').innerText = `$${selectedSum.toLocaleString()}`;
            
            let contriHTML = '';
            for (let name in contriMap) {
                if(contriMap[name] > 0) {
                    contriHTML += `<b>${name}</b>: $${contriMap[name].toLocaleString()}<br>`;
                }
            }
            document.getElementById('contributionSummary').innerHTML = contriHTML || '尚無 Contribution 記錄';
            
            localStorage.setItem('maipo_db', JSON.stringify(db));
        }

        function addRecord() {
            const newItem = {
                id: 'id' + Date.now(),
                date: document.getElementById('date').value,
                details: document.getElementById('details').value,
                category: document.getElementById('category').value,
                expense: parseFloat(document.getElementById('expense').value) || 0,
                person: document.getElementById('person').value,
                checked: false
            };
            if(!newItem.details || !newItem.person) { alert("請填寫詳情及選擇人員"); return; }
            db.push(newItem);
            resetForm();
            render();
        }

        function editRecord(id) {
            const item = db.find(i => i.id === id);
            editId = id;
            document.getElementById('date').value = item.date;
            document.getElementById('details').value = item.details;
            document.getElementById('category').value = item.category;
            document.getElementById('expense').value = item.expense;
            document.getElementById('person').value = item.person;
            document.getElementById('addBtn').style.display = 'none';
            document.getElementById('updateBtn').style.display = 'block';
            window.scrollTo(0,0);
        }

        function updateRecord() {
            const index = db.findIndex(i => i.id === editId);
            db[index] = { ...db[index], 
                date: document.getElementById('date').value,
                details: document.getElementById('details').value,
                category: document.getElementById('category').value,
                expense: parseFloat(document.getElementById('expense').value) || 0,
                person: document.getElementById('person').value
            };
            editId = null;
            resetForm();
            render();
            document.getElementById('addBtn').style.display = 'block';
            document.getElementById('updateBtn').style.display = 'none';
        }

        function deleteRecord(id) {
            if(confirm("確定刪除？")) {
                db = db.filter(i => i.id !== id);
                render();
            }
        }

        function toggleCheck(id) {
            const index = db.findIndex(i => i.id === id);
            db[index].checked = !db[index].checked;
            render();
        }

        function resetForm() {
            document.getElementById('details').value = '';
            document.getElementById('expense').value = '';
            document.getElementById('person').value = '';
        }

        render();
    </script>
</body>
</html>
